name: 'Build Sign Scan'
description: 'Builds a docker image, signs, snyk scans, and pushes to algol60'
inputs:
  DOCKER_REPO:
    description: Full path of repo to push eg csm-docker/stable/curl
    required: true

  DOCKER_TAG:
    description: Tag to use when pushing
    required: true

  CONTEXT_PATH:
    description: Path to folder containing dockerfile to build
    required: true

  # Secrets
  ARTIFACTORY_ALGOL60_TOKEN:
    description: Secret for ARTIFACTORY_ALGOL60_TOKEN
    required: true

  COSIGN_GCP_PROJECT_ID:
    description: Secret for COSIGN_GCP_PROJECT_ID
    required: true

  COSIGN_GCP_SA_KEY:
    description: Secret for COSIGN_GCP_SA_KEY
    required: true

  COSIGN_KEY:
    description: Secret for COSIGN_KEY
    required: true

  SNYK_TOKEN:
    description: Secret for SNYK_TOKEN
    required: true

  # Defaults
  DOCKER_REGISTRY:
    description: Name of registry to push to
    required: true
    default: 'artifactory.algol60.net'

  DOCKER_REGISTRY_USER:
    description: User for authing with registry
    required: true
    default: 'github-actions-cray-hpe'

  DOCKER_REGISTRY_PASSWORD:
    description: Password to auth with registry
    required: true

runs:
  using: "composite"

  steps:
    - name: Install cosign
      uses: sigstore/cosign-installer@main
      with:
        cosign-release: 'v1.0.0'

    - name: Check cosign install
      run: cosign version

    - name: Login to Registry
      uses: docker/login-action@v1
      with:
        registry: artifactory.algol60.net
        username: ${{ inputs.DOCKER_REGISTRY_USER }}
        password: ${{ inputs.DOCKER_REGISTRY_PASSWORD }}

    - name: Set up Cloud SDK for Signing
      uses: google-github-actions/setup-gcloud@master
      with:
        project_id: ${{ inputs.COSIGN_GCP_PROJECT_ID }}
        service_account_key: ${{ inputs.COSIGN_GCP_SA_KEY }}
        export_default_credentials: true

    - name: Use gcloud CLI
      run: gcloud info

    - name: Build
        uses: docker/build-push-action@v2
        with:
          context: ${{ inputs.CONTEXT_PATH }}
          push: true
          tags: |
            ${{ inputs.DOCKER_REGISTRY }}/${{ inputs.DOCKER_REPO }}:${{ inputs.DOCKER_TAG }}
            ${{ inputs.DOCKER_REGISTRY }}/${{ inputs.DOCKER_REPO }}:latest

    - name: Sign
      env:
        COSIGN_KEY: ${{ inputs.COSIGN_KEY }}
      run: |
        cosign sign -key $COSIGN_KEY -a GIT_HASH=$GITHUB_SHA ${{ inputs.DOCKER_REGISTRY }}/${{ inputs.DOCKER_REPO }}:${{ inputs.DOCKER_TAG }}
        cosign sign -key $COSIGN_KEY -a GIT_HASH=$GITHUB_SHA ${{ inputs.DOCKER_REGISTRY }}/${{ inputs.DOCKER_REPO }}:latest

    - name: Snyk Scan
      uses: snyk/actions/docker@master
      env:
        SNYK_TOKEN: ${{ inputs.SNYK_TOKEN }}
      with:
        image: ${{ inputs.DOCKER_REGISTRY }}/${{ inputs.DOCKER_REPO }}:${{ inputs.DOCKER_TAG }}
